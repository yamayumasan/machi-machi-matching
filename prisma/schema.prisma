generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ユーザー
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String?
  nickname     String?
  avatarUrl    String?
  bio          String?
  area         Area?
  latitude     Float?
  longitude    Float?
  locationName String?  // 駅名・ランドマーク名
  isOnboarded  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  interests      UserCategory[]
  wantToDos      WantToDo[]
  recruitments   Recruitment[]   @relation("Creator")
  applications   Application[]   @relation("Applicant")
  sentOffers     Offer[]         @relation("Sender")
  receivedOffers Offer[]         @relation("Receiver")
  groupMembers   GroupMember[]
  messages       Message[]
  notifications  Notification[]
}

model UserCategory {
  id         String   @id @default(cuid())
  userId     String
  categoryId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId])
}

// ============================================
// カテゴリ
// ============================================

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  icon      String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  // Relations
  userCategories UserCategory[]
  wantToDos      WantToDo[]
  recruitments   Recruitment[]
}

// ============================================
// やりたいこと表明
// ============================================

model WantToDo {
  id           String         @id @default(cuid())
  userId       String
  categoryId   String
  timing       Timing         @default(ANYTIME)
  comment      String?
  latitude     Float?
  longitude    Float?
  locationName String?        // 駅名・ランドマーク名
  status       WantToDoStatus @default(ACTIVE)
  expiresAt    DateTime
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([categoryId])
  @@index([status, expiresAt])
}

// ============================================
// 募集
// ============================================

model Recruitment {
  id           String            @id @default(cuid())
  creatorId    String
  categoryId   String
  title        String
  description  String?
  datetime     DateTime?
  datetimeFlex String?
  area         Area
  location     String?
  latitude     Float?
  longitude    Float?
  locationName String?           // 駅名・ランドマーク名
  minPeople    Int               @default(1)
  maxPeople    Int               @default(10)
  status       RecruitmentStatus @default(OPEN)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  closedAt     DateTime?

  creator  User     @relation("Creator", fields: [creatorId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // Relations
  offers       Offer[]
  applications Application[]
  group        Group?

  @@index([creatorId])
  @@index([categoryId])
  @@index([area, status])
}

// ============================================
// 参加申請（ユーザー → 募集者）
// ============================================

model Application {
  id            String            @id @default(cuid())
  recruitmentId String
  applicantId   String
  status        ApplicationStatus @default(PENDING)
  message       String?
  createdAt     DateTime          @default(now())
  respondedAt   DateTime?

  recruitment Recruitment @relation(fields: [recruitmentId], references: [id], onDelete: Cascade)
  applicant   User        @relation("Applicant", fields: [applicantId], references: [id], onDelete: Cascade)

  @@unique([recruitmentId, applicantId])
  @@index([applicantId, status])
}

// ============================================
// オファー（募集者 → ユーザー）
// ============================================

model Offer {
  id            String      @id @default(cuid())
  recruitmentId String
  senderId      String
  receiverId    String
  status        OfferStatus @default(PENDING)
  message       String?
  createdAt     DateTime    @default(now())
  respondedAt   DateTime?

  recruitment Recruitment @relation(fields: [recruitmentId], references: [id], onDelete: Cascade)
  sender      User        @relation("Sender", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User        @relation("Receiver", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([recruitmentId, receiverId])
  @@index([receiverId, status])
}

// ============================================
// グループ
// ============================================

model Group {
  id            String   @id @default(cuid())
  recruitmentId String   @unique
  name          String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  recruitment Recruitment   @relation(fields: [recruitmentId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  messages    Message[]
}

model GroupMember {
  id         String          @id @default(cuid())
  groupId    String
  userId     String
  role       GroupMemberRole @default(MEMBER)
  joinedAt   DateTime        @default(now())
  lastReadAt DateTime        @default(now()) // 最後にメッセージを読んだ日時

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
}

// ============================================
// メッセージ
// ============================================

model Message {
  id        String   @id @default(cuid())
  groupId   String
  senderId  String
  content   String
  createdAt DateTime @default(now())

  group  Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sender User  @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([groupId, createdAt])
}

// ============================================
// 通知
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
}

// ============================================
// Enums
// ============================================

enum Area {
  TOKYO
  SENDAI
}

enum Timing {
  THIS_WEEK
  NEXT_WEEK
  THIS_MONTH
  ANYTIME
}

enum WantToDoStatus {
  ACTIVE
  EXPIRED
  DELETED
}

enum RecruitmentStatus {
  OPEN
  CLOSED
  COMPLETED
  CANCELLED
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum GroupMemberRole {
  OWNER
  MEMBER
}

enum NotificationType {
  APPLICATION_RECEIVED
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  OFFER_RECEIVED
  OFFER_ACCEPTED
  OFFER_DECLINED
  RECRUITMENT_MATCH
  GROUP_CREATED
  NEW_MESSAGE
  MEMBER_JOINED
}
